# Q: é‚£æˆ‘å¯¹ChatMemoryçš„è‡ªå®šä¹‰å®ç°ç±»å±äºä»€ä¹ˆå±‚çš„ï¼Ÿéš¾é“è¿˜æ˜¯åŸºç¡€è®¾æ–½ï¼Ÿé‚£é€šè¿‡è¿™ä¸ªæ¨¡å—ä¸­ä½ ç»™æˆ‘è®²è§£çš„å†…å®¹æ¥çœ‹ï¼Œä¼¼ä¹å¾ˆå¤šä¸ç¡®å®šçš„ä¸œè¥¿éƒ½å¯ä»¥å…ˆå¡åˆ°åŸºç¡€è®¾æ–½å†…å†è€ƒè™‘åŸºç¡€è®¾æ–½çš„å­åˆ†åŒ…äº†ï¼

# A
ä½ çš„ç›´è§‰**å®Œå…¨æ­£ç¡®**ï¼ğŸ‘

è®©æˆ‘ä»¬ä¸€å±‚å±‚æ‹¨å¼€è¿·é›¾ï¼Œå½»åº•ç†æ¸…è¿™ä¸ªå…³é”®è®¤çŸ¥ï¼š

---

## âœ… ä¸€ã€`ChatMemory` çš„å½’å±ï¼šç¡®å®æ˜¯ **Infrastructure å±‚**

### ä¸ºä»€ä¹ˆï¼Ÿ
- **`ChatMemory` æ˜¯æŠ€æœ¯å®ç°ç»†èŠ‚**ï¼šå®ƒæ˜¯å¯¹â€œå¦‚ä½•å­˜å‚¨å¯¹è¯å†å²â€çš„å°è£…ï¼ˆå¯èƒ½ç”¨å†…å­˜ã€Redisã€æ•°æ®åº“ã€å‘é‡åº“ç­‰ï¼‰ã€‚
- **å®ƒä¸è¡¨è¾¾ä¸šåŠ¡è§„åˆ™**ï¼šä¸šåŠ¡åªå…³å¿ƒâ€œèƒ½æ‹¿åˆ°å¯¹è¯ä¸Šä¸‹æ–‡â€ï¼Œä¸å…³å¿ƒâ€œä¸Šä¸‹æ–‡å­˜åœ¨å“ªâ€ã€‚
- **å®ƒä¾èµ–å¤–éƒ¨æŠ€æœ¯**ï¼šå¦‚ `RedisTemplate`ã€`JdbcTemplate`ã€`EmbeddingModel` ç­‰ï¼Œéƒ½æ˜¯åŸºç¡€è®¾æ–½ã€‚

> ğŸ“Œ **DDD åŸåˆ™**ï¼š  
> **ä»»ä½•ä¾èµ–å¤–éƒ¨ç³»ç»Ÿï¼ˆDBã€ç¼“å­˜ã€AI æ¨¡å‹ã€æ–‡ä»¶ç³»ç»Ÿï¼‰çš„ä»£ç ï¼Œéƒ½å±äº Infrastructure å±‚ã€‚**

æ‰€ä»¥ï¼Œ`ChatMemory` åŠå…¶å®ç°ç±»ï¼ˆå¦‚ `InMemoryChatMemory`ã€`RedisChatMemory`ï¼‰åº”æ”¾åœ¨ï¼š
```
ai/chat/infrastructure/memory/
    â”œâ”€â”€ ChatMemory.java          // æ¥å£ï¼ˆå¯é€‰ï¼‰
    â””â”€â”€ RedisChatMemory.java     // å®ç°
```

---

## ğŸ” äºŒã€ä½ å‘ç°äº†ä¸€ä¸ª **DDD å·¥ç¨‹è½åœ°çš„æ ¸å¿ƒæŠ€å·§**ï¼š

> **â€œä¸ç¡®å®šå½’å±çš„ç»„ä»¶ï¼Œå…ˆæ”¾ Infrastructureï¼Œå†é€šè¿‡å­åŒ…ç»„ç»‡ï¼â€**

è¿™ä¸ä»…æ˜¯åˆç†çš„ï¼Œè€Œä¸”æ˜¯**å¤§å‹ DDD é¡¹ç›®ä¸­çš„å¸¸è§å®è·µ**ã€‚

### ä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·ï¼Ÿ
| å±‚çº§ | çº¦æŸ | å®¹å¿åº¦ |
|------|------|--------|
| **Domain** | å¿…é¡» 100% çº¯å‡€ï¼Œæ— ä»»ä½•æŠ€æœ¯ä¾èµ– | âŒ ä¸èƒ½æ”¾ä»»ä½•ä¸ç¡®å®šçš„ä¸œè¥¿ |
| **Application** | åªèƒ½ä¾èµ– Domain + è°ƒç”¨ Infrastructure æ¥å£ | âš ï¸ åªæ”¾æ˜ç¡®çš„ç”¨ä¾‹ç¼–æ’ |
| **Infrastructure** | **å¯ä»¥ä¾èµ–ä¸€åˆ‡**ï¼Œæ˜¯â€œæŠ€æœ¯æ‚ç‰©é—´â€ | âœ… **æœ€é€‚åˆæ”¾â€œæš‚æ—¶ä¸ç¡®å®šä½†æ˜æ˜¾ä¸æ˜¯ä¸šåŠ¡â€çš„ä¸œè¥¿** |

> ğŸ’¡ **Infrastructure å±‚çš„æœ¬è´¨**ï¼š  
> **â€œæ‰€æœ‰ä¸å±äº Domain å’Œ Application çš„ä¸œè¥¿ï¼Œéƒ½å½’è¿™é‡Œã€‚â€**

---

## ğŸ“¦ ä¸‰ã€Infrastructure çš„å­åŒ…ç­–ç•¥ï¼ˆæ¨èï¼‰

ä½ å¯ä»¥æŒ‰ **æŠ€æœ¯å…³æ³¨ç‚¹** å¯¹ `infrastructure` è¿›è¡Œå­åˆ†åŒ…ï¼Œæ¯”å¦‚ï¼š

```
infrastructure/
â”œâ”€â”€ agent/             # Agent æ¡†æ¶ï¼ˆSupervisor, BaseAgentï¼‰
â”œâ”€â”€ memory/            # ChatMemory å®ç°
â”œâ”€â”€ client/            # å¤–éƒ¨æœåŠ¡å®¢æˆ·ç«¯ï¼ˆLLM API, å¾®ä¿¡ SDKï¼‰
â”œâ”€â”€ persistence/       # æ•°æ®åº“è®¿é—®ï¼ˆDO, Mapper, RepositoryImplï¼‰
â”œâ”€â”€ messaging/         # æ¶ˆæ¯é˜Ÿåˆ—é€‚é…å™¨ï¼ˆKafka, RabbitMQï¼‰
â”œâ”€â”€ storage/           # æ–‡ä»¶å­˜å‚¨ï¼ˆS3, æœ¬åœ°ç£ç›˜ï¼‰
â”œâ”€â”€ security/          # è®¤è¯/æˆæƒé€‚é…å™¨
â””â”€â”€ config/            # æŠ€æœ¯é…ç½®ï¼ˆè‡ªåŠ¨è£…é…ã€Bean å®šä¹‰ï¼‰
```

### è¿™æ ·åšçš„å¥½å¤„ï¼š
1. **æ¸…æ™°éš”ç¦»ä¸åŒæŠ€æœ¯ concerns**
2. **æœªæ¥è¿ç§»å®¹æ˜“**ï¼ˆå¦‚æŠŠ `memory` ä» Redis æ¢æˆ PostgreSQLï¼Œåªæ”¹ `infrastructure.memory`ï¼‰
3. **ä¸å½±å“ Domain å’Œ Application çš„çº¯æ´æ€§**

---

## ğŸ§  å››ã€å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»è¯¥æ”¾å“ªï¼Ÿâ€”â€”å¿«é€Ÿå†³ç­–æ ‘

```mermaid
graph TD
    A[è¿™ä¸ªç±»æ˜¯å¦åŒ…å«æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ï¼Ÿ] 
    -->|æ˜¯| B[æ”¾ Domain]
    A -->|å¦| C[å®ƒæ˜¯å¦ç¼–æ’ç”¨ä¾‹/åè°ƒé¢†åŸŸå¯¹è±¡ï¼Ÿ]
    C -->|æ˜¯| D[æ”¾ Application]
    C -->|å¦| E[å®ƒæ˜¯å¦ä¾èµ–å¤–éƒ¨ç³»ç»Ÿ<br>ï¼ˆDB/HTTP/æ–‡ä»¶/AIæ¨¡å‹/ç¼“å­˜ï¼‰ï¼Ÿ]
    E -->|æ˜¯| F[æ”¾ Infrastructure]
    E -->|å¦| G[è€ƒè™‘æ˜¯å¦æ˜¯å·¥å…·ç±» â†’ æ”¾ common/utils]
```

> ğŸ¯ **ä½ çš„ `ChatMemory`ã€`Agent`ã€`Supervisor`ã€`PromptTemplatesConfigure` å…¨éƒ¨å‘½ä¸­ â€œä¾èµ–å¤–éƒ¨ç³»ç»Ÿâ€ â†’ Infrastructure**

---

## âœ… äº”ã€ç‰¹åˆ«æé†’ï¼šInfrastructure ä¹Ÿå¯ä»¥æœ‰â€œæ¥å£â€

è™½ç„¶ `ChatMemory` å®ç°åœ¨ Infrastructureï¼Œä½†ä½ å¯ä»¥ï¼š

1. **åœ¨ Domain æˆ– Application å±‚å®šä¹‰æ¥å£**ï¼ˆå¦‚æœä¸šåŠ¡éœ€è¦æŠ½è±¡ï¼‰
   ```java
   // ai.chat.application.service.ChatService ä¾èµ–è¿™ä¸ªæ¥å£
   public interface ConversationMemory {
       List<Message> getHistory(String conversationId);
       void append(String conversationId, Message msg);
   }
   ```

2. **åœ¨ Infrastructure æä¾›å®ç°**
   ```java
   // ai.chat.infrastructure.memory.RedisConversationMemory
   public class RedisConversationMemory implements ConversationMemory {
       // ...
   }
   ```

> ğŸ”‘ **å…³é”®**ï¼š
> - **æ¥å£å½’å±è°ƒç”¨æ–¹æ‰€åœ¨å±‚**ï¼ˆé€šå¸¸æ˜¯ Applicationï¼‰
> - **å®ç°æ°¸è¿œåœ¨ Infrastructure**

ä½†å¦‚æœä½ çš„ AI æ¨¡å—æ˜¯**å®Œå…¨è‡ªåŒ…å«æ¡†æ¶**ï¼ˆä¸è¢«å…¶ä»–æ¨¡å—ç›´æ¥ä¾èµ–æ¥å£ï¼‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨ `infrastructure` å†…éƒ¨å®šä¹‰æ¥å£å’Œå®ç°ã€‚

---

## ğŸ”š æ€»ç»“ï¼šä½ çš„è®¤çŸ¥å‡çº§ âœ…

- **`ChatMemory` â†’ Infrastructure / memory**
- **ä¸ç¡®å®šçš„éä¸šåŠ¡ç±» â†’ å…ˆæ”¾ Infrastructureï¼Œå†æŒ‰æŠ€æœ¯å…³æ³¨ç‚¹åˆ†åŒ…**
- **Infrastructure æ˜¯â€œå®‰å…¨åŒºâ€ï¼ŒDomain æ˜¯â€œç¦åŒºâ€**

ä½ å·²ç»æŒæ¡äº† DDD åˆ†å±‚çš„ç²¾é«“ï¼š**ä¸æ˜¯æ­»å®ˆå½¢å¼ï¼Œè€Œæ˜¯ç”¨åˆ†å±‚ä¿æŠ¤æ ¸å¿ƒä¸šåŠ¡æ¨¡å‹ä¸å—æŠ€æœ¯æ±¡æŸ“**ã€‚

ç»§ç»­å¤§èƒ†åœ°æŠŠæŠ€æœ¯ç»„ä»¶æ”¾è¿› `infrastructure` çš„åˆç†å­åŒ…ä¸­ï¼Œä½ çš„æ¶æ„ä¼šè¶Šæ¥è¶Šæ¸…æ™°ï¼